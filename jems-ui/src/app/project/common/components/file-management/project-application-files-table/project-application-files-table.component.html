<ng-container *ngIf="data$ | async as data">
    <mat-table *ngIf="data.files.content?.length; else noFiles"
               [dataSource]="dataSource" appNoWidthLimit>

        <ng-container matColumnDef="name">
            <mat-header-cell *matHeaderCellDef>{{'file.table.column.name.name' | translate }}</mat-header-cell>
            <mat-cell *matCellDef="let file">{{ file?.name }}</mat-cell>
        </ng-container>

        <ng-container matColumnDef="uploadDate">
            <mat-header-cell *matHeaderCellDef>{{'file.table.column.name.timestamp' | translate }}</mat-header-cell>
            <mat-cell *matCellDef="let file">
                {{ file?.uploadedAt | localeDate: 'L' : 'LT'}}
            </mat-cell>
        </ng-container>

        <ng-container matColumnDef="user">
            <mat-header-cell *matHeaderCellDef>{{'file.table.column.name.username' | translate }}</mat-header-cell>
            <mat-cell *matCellDef="let file">{{ file?.uploadedBy?.email }}</mat-cell>
        </ng-container>

        <ng-container matColumnDef="description">
            <mat-header-cell *matHeaderCellDef>{{'file.table.column.name.description' | translate }}</mat-header-cell>
            <mat-cell *matCellDef="let file">
                <app-description-cell
                        (editFinished)="editableDescriptionFileId = null"
                        (saveFile)="setFileDescription($event)"
                        [editable]="editableDescriptionFileId === file?.id"
                        [file]="file">
                </app-description-cell>
            </mat-cell>
        </ng-container>

        <ng-container matColumnDef="actions">
            <mat-header-cell *matHeaderCellDef class="justify-end">
                {{'file.table.column.name.action' | translate }}
            </mat-header-cell>
            <mat-cell *matCellDef="let file" class="justify-end">
                <app-actions-cell
                        (delete)="deleteFile($event)"
                        (download)="downloadFile($event)"
                        (edit)="editableDescriptionFileId = $event"
                        [file]="file"
                        [isAllowedToChangeApplicationFile]="fileManagementStore.canChangeApplicationFile$ | async"
                        [isAllowedToChangeAssessmentFile]="fileManagementStore.canChangeAssessmentFile$ | async"
                        [isThisUserOwner]="fileManagementStore.userIsProjectOwner$ | async"
                        [projectStatus]="data.projectStatus"
                        [type]="data.selectedCategory?.type">
                </app-actions-cell>
            </mat-cell>
        </ng-container>

        <mat-header-row *matHeaderRowDef="displayedColumns"></mat-header-row>
        <mat-row *matRowDef="let row; columns: displayedColumns"></mat-row>

    </mat-table>

    <app-paginator (pageIndexChanged)="fileManagementStore.newPageIndex$.next($event)"
                   (pageSizeChanged)="fileManagementStore.newPageSize$.next($event)"
                   *ngIf="data.files.content?.length"
                   [currentPageIndex]="Tables.DEFAULT_INITIAL_PAGE_INDEX"
                   [currentPageSize]="Tables.DEFAULT_INITIAL_PAGE_SIZE"
                   [length]="data.files.totalElements">
    </app-paginator>

    <div *ngIf="fileManagementStore.canUpload$ | async">
        <input #selectFile (change)="uploadFile($event?.target)" onclick="this.value=null;"
               type="file" [accept]="acceptedFilesTypes">
        <button (click)="selectFile.click()"
                mat-stroked-button>+ {{'file.upload.add.new' | translate}}
        </button>
    </div>
</ng-container>

<app-alert [show]="fileManagementStore.deleteSuccess$ | async"
           [type]="Alert.SUCCESS">
    <p>{{'file.delete.message.successful' | translate}}</p>
</app-alert>
<app-alert *ngIf="fileManagementStore.error$ | async as error"
           [show]="!!error"
           [type]="Alert.ERROR">
    <app-api-error-content [error]="error"></app-api-error-content>
</app-alert>
<app-alert *ngIf="fileSizeOverLimitError$ | async as showError"
           [show]="showError"
           [type]="Alert.ERROR">
    <p>{{'project.file.size.over.limit' | translate}} {{maximumAllowedFileSizeInMB}} MB</p>
</app-alert>

<ng-template #noFiles>
    <app-alert [show]="true"
               [type]="Alert.WARNING">
        <p>{{'file.table.no.files' | translate}}</p>
    </app-alert>
</ng-template>
