<ng-container *ngIf="(data$ | async) as data">
    <app-form (save)="updateActivities()">
        <form appFormLayout [formGroup]="form">
            <h3>{{'project.work.package.tab.title' | translate}}</h3>
            <p>{{'project.work.package.tab.intro' | translate}}</p>
            <div appNoWidthLimit *ngFor="let activity of activities.controls;let i=index">
                <ng-container [formArrayName]="constants.ACTIVITIES.name">
                    <div appFormLayout [formGroupName]="i" class="activity-container">
                        <div class="activity-header" appNoWidthLimit appMultiColumnRow itemsAlign="space-between">
                            <h4 appMultiColumnRow class="mb-0">
                                <span>{{('project.work.package.tab.activity' | translate) + ' ' + data.workPackageNumber + '.' + (i + 1) }}</span>
                                <span appFormFieldWidth="xx-large"
                                      class="text-overflow-ellipsis">{{languageService.getCurrentValue(activity.get(constants.TITLE.name).value)}}</span>
                            </h4>

                            <button *ngIf="form.enabled"
                                    type="button" mat-icon-button color="accent"
                                    (click)="removeActivity(i)">
                                <mat-icon>delete</mat-icon>
                            </button>
                        </div>
                        <app-multi-language>
                            <app-multi-language-form-field
                                    [label]="'project.work.package.tab.activity.title'"
                                    [formControlName]="constants.TITLE.name"
                                    [maxLength]="constants.TITLE.maxLength">
                            </app-multi-language-form-field>
                        </app-multi-language>

                        <div>
                            <div appMultiColumnRow stretch>
                                <app-project-periods-select
                                        [periods]="data.periods"
                                        [control]="activity.get(constants.START_PERIOD.name)"
                                        label='project.work.package.tab.activity.start.period'
                                        (selectionChanged)="formService.setDirty(true)">
                                </app-project-periods-select>

                                <app-project-periods-select
                                        [periods]="data.periods"
                                        [control]="activity.get(constants.END_PERIOD.name)"
                                        label='project.work.package.tab.activity.end.period'
                                        (selectionChanged)="formService.setDirty(true)">
                                </app-project-periods-select>
                            </div>
                            <mat-error *ngIf="activity.errors">
                                <app-form-field-errors
                                        [errors]="activity.errors"
                                        [messages]="constants.PERIODS.errorMessages"></app-form-field-errors>
                            </mat-error>
                        </div>

                        <app-multi-language>
                            <app-multi-language-form-field [label]="'project.work.package.tab.activity.description'"
                                                           [formControlName]="constants.DESCRIPTION.name"
                                                           [maxLength]="constants.DESCRIPTION.maxLength">
                            </app-multi-language-form-field>
                        </app-multi-language>

                        <h4>{{'Deliverables' | translate}}</h4>
                        <p>{{'project.work.package.tab.deliverables.intro' | translate}}</p>
                        <app-multi-language appNoWidthLimit *ngIf="deliverables(i).controls?.length">
                            <div [appTableConfig]="[{maxInRem:3},{minInRem:15},{minInRem:10}, {maxInRem:2}]">
                                <div>
                                    <span class="mat-body-strong">{{'project.work.package.tab.deliverables.number' | translate }}</span>
                                    <span class="mat-body-strong">{{'project.work.package.tab.deliverables.deliverable' | translate }}</span>
                                    <span class="mat-body-strong">{{'project.work.package.tab.deliverables.period' | translate }}</span>
                                    <div class="mat-body-strong"></div>
                                </div>
                                <div *ngFor="let deliverable of deliverables(i).controls;let j=index">
                                    <ng-container [formArrayName]="constants.DELIVERABLES.name">
                                        <ng-container [formGroupName]="j">
                                            <div>D.{{data.workPackageNumber}}.{{i + 1}}.{{j + 1}}</div>

                                            <app-multi-language-form-field
                                                    [label]="'project.work.package.tab.deliverables.deliverable'"
                                                    [formControlName]="constants.DELIVERABLE.name"
                                                    [maxLength]="constants.DELIVERABLE.maxLength">
                                            </app-multi-language-form-field>

                                            <app-project-periods-select
                                                    [periods]="data.periods"
                                                    [control]="deliverable.get(constants.PERIOD.name)"
                                                    label='project.work.package.tab.deliverables.period'
                                                    (selectionChanged)="formService.setDirty(true)">
                                            </app-project-periods-select>

                                            <div>
                                                <button *ngIf="form.enabled"
                                                        type="button"
                                                        (click)="removeDeliverable(i, j)"
                                                        mat-icon-button
                                                        color="accent">
                                                    <mat-icon>delete</mat-icon>
                                                </button>
                                            </div>
                                        </ng-container>
                                    </ng-container>
                                </div>
                            </div>
                        </app-multi-language>
                        <button *ngIf="addDeliverableVisible(i)" mat-stroked-button type="button"
                                (click)="addNewDeliverable(i)">
                            <mat-icon>add</mat-icon>
                        </button>
                    </div>
                </ng-container>
            </div>
            <button *ngIf="addActivityVisible()" mat-stroked-button (click)="addNewActivity()">
                + {{'project.work.package.tab.activity.add' | translate}}
            </button>
        </form>
    </app-form>
</ng-container>
