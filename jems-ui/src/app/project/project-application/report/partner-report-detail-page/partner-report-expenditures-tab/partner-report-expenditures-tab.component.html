<div *ngIf="data$ | async as data">
    <jems-form (save)="updateReportExpenditures()"
               (discard)="refreshListOfExpenditures()">
        <h3>{{'project.application.partner.report.expenditures.title' | translate}}

            <jems-context-info infoPosition="right"
                               infoText="{{'project.application.partner.report.expenditures.title.infobubble.description' | translate}}">
            </jems-context-info>
        </h3>
        <p>{{'project.application.partner.report.expenditures.currencies.info.message' | translate}}</p>

        <form jemsFormLayout [formGroup]="reportExpendituresForm">
            <div id="table-container" jemsNoWidthLimit *ngIf="tableData.length > 0">
                <jems-multi-language-container>
                    <mat-table #expenditureCostsTable
                               jemsNoWidthLimit
                               id="expenditure-costs-table"
                               class="table-condensed"
                               [jemsTableConfig]="data.withConfigs"
                               [dataSource]="tableData"
                               [formArrayName]="constants.FORM_CONTROL_NAMES.items">
                        <ng-container matColumnDef="costItemID" stickyEnd>
                            <mat-header-cell *matHeaderCellDef>
                                        <span jemsText
                                              maxLines="2">{{'project.application.partner.report.expenditures.tab.cost.ID' | translate}}</span>
                            </mat-header-cell>
                            <mat-cell *matCellDef="let control;  let i = index" [formGroupName]="i">
                                <div class="text-overflow-ellipsis" *ngIf="!control.get(constants.FORM_CONTROL_NAMES.reportOfOriginNumber).value">
                                    {{'R' + currentReport.reportNumber + '.' + (control.get('id').value ? control.get(constants.FORM_CONTROL_NAMES.number).value : '?')}}
                                </div>
                                <div class="text-overflow-ellipsis" *ngIf="control.get(constants.FORM_CONTROL_NAMES.reportOfOriginNumber).value">
                                    {{'R' + control.get(constants.FORM_CONTROL_NAMES.reportOfOriginNumber).value + '.' + control.get(constants.FORM_CONTROL_NAMES.originalExpenditureNumber).value}}
                                </div>
                            </mat-cell>
                            <mat-footer-cell *matFooterCellDef></mat-footer-cell>
                        </ng-container>

                        <ng-container matColumnDef="costGDPR" sticky>
                            <mat-header-cell *matHeaderCellDef>
                                        <div class ="custom-icon gdpr">
                                            <mat-icon matTooltip="{{'project.application.partner.report.expenditures.tab.cost.checkbox.sensitive.info' | translate}}">
                                                privacy_tip
                                            </mat-icon>
                                        </div>
                            </mat-header-cell>
                            <mat-cell *matCellDef="let control;  let i = index" [formGroupName]="i">
                                <mat-checkbox
                                        [disabled]="!data.isGDPRCompliant || !data.isReportEditable"
                                        (click)="$event.stopPropagation()"
                                        (change)="toggleGDPR(i, control, !control.get(constants.FORM_CONTROL_NAMES.costGDPR).value)"
                                        [checked]="control.get(constants.FORM_CONTROL_NAMES.costGDPR).value === true">
                                </mat-checkbox>
                            </mat-cell>
                            <mat-footer-cell *matFooterCellDef></mat-footer-cell>
                        </ng-container>

                        <ng-container matColumnDef="parkedBy">
                            <mat-header-cell *matHeaderCellDef>
                                <span jemsText maxLines="2">{{'project.application.partner.report.expenditures.tab.cost.parked.by' | translate}}</span>
                            </mat-header-cell>
                            <mat-cell *matCellDef="let control;  let i = index" [formGroupName]="i">
                                <jems-expenditure-item-parked-by-chip [parkedBy]="getParkedBy(control.get(constants.FORM_CONTROL_NAMES.parkingMetadata)?.value)"></jems-expenditure-item-parked-by-chip>
                            </mat-cell>
                            <mat-footer-cell *matFooterCellDef></mat-footer-cell>
                        </ng-container>

                        <ng-container matColumnDef="costOptions">
                            <mat-header-cell *matHeaderCellDef>
                                        <span jemsText
                                              maxLines="2">{{'project.application.partner.report.expenditures.tab.cost.lump.sum' | translate}}</span>
                            </mat-header-cell>
                            <mat-cell *matCellDef="let control;  let i = index" [formGroupName]="i">
                                <div *ngIf="expenditureFormIndex !== i && !control.get(constants.FORM_CONTROL_NAMES.costOptions).errors"
                                     (click)="selectRow(i, 'costOptions')" class="custom-wrapper pointer"
                                     [matTooltip]="getCostOptionsDefinition(control.get(constants.FORM_CONTROL_NAMES.costOptions).value) | async"
                                     [matTooltipClass]="'tooltip'"
                                     [ngClass]="getAdditionalRowClass(i, constants.FORM_CONTROL_NAMES.costOptions)">
                                    <div class="custom-dropdown-text">
                                        <div>
                                            {{getCostOptionsDefinition(control.get(constants.FORM_CONTROL_NAMES.costOptions).value) | async}}
                                        </div>
                                    </div>
                                    <div *ngIf="!control.get(constants.FORM_CONTROL_NAMES.costOptions).disabled" class="custom-icon">
                                        <mat-icon class="arrow">arrow_drop_down</mat-icon>
                                    </div>
                                </div>

                                <mat-form-field *ngIf="expenditureFormIndex === i || control.get(constants.FORM_CONTROL_NAMES.costOptions).errors" jemsFormFieldWidth="full">
                                    <mat-select #costOptionsSelect
                                                (selectionChange)="onCostOptionChange($event, control, i)"
                                                [formControlName]="constants.FORM_CONTROL_NAMES.costOptions"
                                                [matTooltip]="costOptionsSelect.triggerValue"
                                                [placeholder]="'common.not.applicable.option' | translate">
                                        <mat-option
                                                [value]="null">{{'common.not.applicable.option' | translate}}</mat-option>
                                        <mat-optgroup *ngIf="data.lumpSums.length" [label]="'lump.sums.table.title' | translate">
                                            <mat-option *ngFor="let lumpSum of data.lumpSums"
                                                        [value]="lumpSum"
                                                        [matTooltip]="getCostOptionsDefinition(lumpSum) | async">
                                                <span>{{ (lumpSum.name | translateByInputLanguage | async) }}</span>
                                                <span *ngIf="lumpSum.period !== null && lumpSum.period !== undefined">
                                                    - {{ lumpSum.period === PERIOD_PREPARATION ? ('project.application.form.section.part.e.period.preparation' | translate) :
                                                    (lumpSum.period === PERIOD_CLOSURE ? ('project.application.form.section.part.e.period.closure' | translate) :
                                                        ('project.partner.budget.table.period' | translate) + ' ' + lumpSum.period) }}
                                                </span>
                                            </mat-option>
                                        </mat-optgroup>
                                        <mat-optgroup *ngIf="data.unitCosts.length" [label]="'unit.cost.table.title' | translate">
                                            <mat-option *ngFor="let unitCost of data.unitCosts"
                                                        [value]="unitCost"
                                                        [matTooltip]="(unitCost.name | translateByInputLanguage | async)">
                                                {{ (unitCost.projectDefined ? 'E.2.1_' : '') + (unitCost.name| translateByInputLanguage | async) }}
                                            </mat-option>
                                        </mat-optgroup>
                                    </mat-select>
                                </mat-form-field>
                            </mat-cell>
                            <mat-footer-cell *matFooterCellDef></mat-footer-cell>
                        </ng-container>

                        <ng-container matColumnDef="costCategory">
                            <mat-header-cell *matHeaderCellDef>
                                        <span jemsText
                                              maxLines="2">{{'project.application.partner.report.expenditures.tab.cost.category' | translate}}</span>
                            </mat-header-cell>
                            <mat-cell *matCellDef="let control;  let i = index" [formGroupName]="i">
                                <div *ngIf="expenditureFormIndex !== i && !control.get(constants.FORM_CONTROL_NAMES.costCategory).errors"
                                     [matTooltip]="('project.application.partner.report.expenditures.cost.category.' + control.get(constants.FORM_CONTROL_NAMES.costCategory).value) | translate"
                                     [matTooltipClass]="'tooltip'"
                                     (click)="selectRow(i, 'costCategory')" class="custom-wrapper pointer"
                                     [ngClass]="getAdditionalRowClass(i, constants.FORM_CONTROL_NAMES.costCategory)">
                                    <div class="custom-dropdown-text cost-category">
                                        {{ ('project.application.partner.report.expenditures.cost.category.' + control.get(constants.FORM_CONTROL_NAMES.costCategory).value) | translate}}
                                    </div>
                                    <div *ngIf="!control.get(constants.FORM_CONTROL_NAMES.costCategory).disabled" class="custom-icon cost-category">
                                        <mat-icon>arrow_drop_down</mat-icon>
                                    </div>
                                </div>

                                <mat-form-field *ngIf="expenditureFormIndex === i || control.get(constants.FORM_CONTROL_NAMES.costCategory).errors" jemsFormFieldWidth="full">
                                    <mat-select class="placeholder-required" required
                                                #costCategorySelect
                                                (selectionChange)="onCostCategoryChange($event, control, i)"
                                                [formControlName]="constants.FORM_CONTROL_NAMES.costCategory"
                                                [matTooltip]="costCategorySelect.triggerValue"
                                                [placeholder]="'project.application.partner.report.expenditures.cost.category.placeholder' | translate">
                                        <mat-option *ngIf="isCostOptionSelectedInCurrentFormGroup(i)"
                                                [value]="control.get(constants.FORM_CONTROL_NAMES.costCategory).value">
                                            {{'project.application.partner.report.expenditures.cost.category.' + control.get(constants.FORM_CONTROL_NAMES.costCategory).value | translate}}
                                        </mat-option>
                                        <mat-option *ngFor="let costCategory of data.costCategories"
                                                    [value]="costCategory">
                                            {{ ('project.application.partner.report.expenditures.cost.category.' + costCategory) | translate}}
                                        </mat-option>
                                    </mat-select>
                                </mat-form-field>
                            </mat-cell>
                            <mat-footer-cell *matFooterCellDef></mat-footer-cell>
                        </ng-container>

                        <ng-container *ngIf="data.investmentsSummary.length > 0" matColumnDef="investmentId">
                            <mat-header-cell *matHeaderCellDef>
                                        <span jemsText
                                              maxLines="2">{{'project.application.partner.report.expenditures.tab.investment.number' | translate}}</span>
                            </mat-header-cell>
                            <mat-cell *matCellDef="let control;  let i = index" [formGroupName]="i">
                                <div *ngIf="expenditureFormIndex !== i && !control.get(constants.FORM_CONTROL_NAMES.investmentId).errors"
                                     (click)="selectRow(i, 'investmentId')" class="custom-wrapper pointer"
                                     [matTooltip]="getInvestmentIdValue(control.get(constants.FORM_CONTROL_NAMES.investmentId).value)"
                                     [matTooltipClass]="'tooltip'"
                                     [ngClass]="getAdditionalRowClass(i, constants.FORM_CONTROL_NAMES.investmentId)">
                                    <div class="custom-dropdown-text">
                                        <span *ngIf="control.get(constants.FORM_CONTROL_NAMES.investmentId).value">
                                            <mat-icon *ngIf="getInvestmentInactive(control.get(constants.FORM_CONTROL_NAMES.investmentId).value)" class="inactive-icon-dropdown mt-1">hide_source</mat-icon>
                                            {{getInvestmentIdValue(control.get(constants.FORM_CONTROL_NAMES.investmentId).value)}}
                                        </span>
                                        <span *ngIf="!control.get(constants.FORM_CONTROL_NAMES.investmentId).value">
                                            {{'common.not.applicable.option' | translate}}
                                        </span>
                                    </div>
                                    <div *ngIf="!control.get(constants.FORM_CONTROL_NAMES.investmentId).disabled" class="custom-icon">
                                        <mat-icon class="arrow">arrow_drop_down</mat-icon>
                                    </div>
                                </div>

                                <mat-form-field *ngIf="expenditureFormIndex === i || control.get(constants.FORM_CONTROL_NAMES.investmentId).errors" jemsFormFieldWidth="full">
                                    <mat-select
                                        #investmentNumber
                                        (selectionChange)="onInvestmentNumberChange($event, control)"
                                        [formControlName]="constants.FORM_CONTROL_NAMES.investmentId"
                                        [matTooltip]="getInvestmentIdValue(control.get(constants.FORM_CONTROL_NAMES.investmentId).value)"
                                        [placeholder]="'common.not.applicable.option' | translate">
                                        <mat-select-trigger>
                                            <span>
                                                <mat-icon class="inactive-icon" *ngIf="getInvestmentInactive(control.get(constants.FORM_CONTROL_NAMES.investmentId).value)">hide_source</mat-icon>
                                                {{getInvestmentIdValue(control.get(constants.FORM_CONTROL_NAMES.investmentId).value)}}
                                            </span>
                                        </mat-select-trigger>
                                        <mat-option
                                                [value]="null">{{'common.not.applicable.option' | translate}}</mat-option>
                                        <mat-option *ngFor="let investment of data.investmentsSummary"
                                                    [value]="investment.id">
                                            <mat-icon *ngIf="investment.deactivated" class="inactive-icon mr-0">hide_source</mat-icon>
                                            {{investment.toString()}}
                                        </mat-option>
                                    </mat-select>
                                </mat-form-field>
                            </mat-cell>
                            <mat-footer-cell *matFooterCellDef></mat-footer-cell>
                        </ng-container>

                        <ng-container matColumnDef="contractId">
                            <mat-header-cell *matHeaderCellDef>
                                        <span jemsText
                                              maxLines="2">{{'project.application.partner.report.expenditures.tab.contract.ID' | translate}}</span>
                            </mat-header-cell>
                            <mat-cell *matCellDef="let control;  let i = index" [formGroupName]="i">
                                <div *ngIf="!ReportUtil.isPartnerReportSubmittable(this.currentReport.status) && expenditureFormIndex !== i && !control.get(constants.FORM_CONTROL_NAMES.contractId).errors"
                                      (click)="selectRow(i, 'contractId')" class="custom-wrapper pointer"
                                      [matTooltip]="getContractIdValue(control.get(constants.FORM_CONTROL_NAMES.contractId).value) ?? ('common.not.applicable.option' | translate)"
                                      [matTooltipClass]="'tooltip'"
                                      [ngClass]="getAdditionalRowClass(i, constants.FORM_CONTROL_NAMES.contractId)">
                                    <div class="custom-dropdown-text">
                                        <a *ngIf="control.get(constants.FORM_CONTROL_NAMES.contractId).value"
                                           [routerLink]="'/app/project/detail/' + data.projectId + '/reporting/' + data.partnerId + '/reports/' + data.partnerReportId + '/procurements/' + control.get(constants.FORM_CONTROL_NAMES.contractId).value">
                                           <span>
                                                {{getContractIdValue(control.get(constants.FORM_CONTROL_NAMES.contractId).value)}}
                                           </span>
                                        </a>
                                        <span *ngIf="!control.get(constants.FORM_CONTROL_NAMES.contractId).value">
                                            {{'common.not.applicable.option' | translate}}
                                        </span>
                                    </div>
                                    <div *ngIf="!control.get(constants.FORM_CONTROL_NAMES.contractId).disabled" class="custom-icon">
                                        <mat-icon class="arrow">arrow_drop_down</mat-icon>
                                    </div>
                                </div>

                                <mat-form-field *ngIf="ReportUtil.isPartnerReportSubmittable(this.currentReport.status) || (expenditureFormIndex === i || control.get(constants.FORM_CONTROL_NAMES.contractId).errors)" jemsFormFieldWidth="full">
                                    <mat-select
                                        #contractId
                                        [formControlName]="constants.FORM_CONTROL_NAMES.contractId"
                                        [matTooltip]="contractId.triggerValue"
                                        [placeholder]="'common.not.applicable.option' | translate">
                                        <mat-option
                                                [value]="null">{{'common.not.applicable.option' | translate}}</mat-option>
                                        <mat-option *ngFor="let contractID of data.contractIDs"
                                                    [value]="contractID.id">
                                            {{ contractID.name }}
                                        </mat-option>
                                    </mat-select>
                                </mat-form-field>
                            </mat-cell>
                            <mat-footer-cell *matFooterCellDef></mat-footer-cell>
                        </ng-container>

                        <ng-container matColumnDef="internalReferenceNumber">
                            <mat-header-cell *matHeaderCellDef>
                                        <span jemsText
                                              maxLines="2">{{'project.application.partner.report.expenditures.tab.internal.reference.number' | translate}}</span>
                            </mat-header-cell>
                            <mat-cell *matCellDef="let control;  let i = index" [formGroupName]="i">
                                <div *ngIf="expenditureFormIndex !== i && !control.get(constants.FORM_CONTROL_NAMES.internalReferenceNumber).errors"
                                     (click)="selectRow(i, 'internalReferenceNumber')" class="custom-wrapper"
                                     [matTooltip]="getLimitedTextInputTooltip(control.get(constants.FORM_CONTROL_NAMES.internalReferenceNumber).value, constants.MAX_LENGTH_INVOICE)"
                                     [matTooltipClass]="'tooltip'"
                                     [ngClass]="getAdditionalRowClass(i, constants.FORM_CONTROL_NAMES.internalReferenceNumber)">
                                    <div class="custom-text-area">
                                        {{control.get(constants.FORM_CONTROL_NAMES.internalReferenceNumber).value}}
                                    </div>
                                </div>

                                <mat-form-field *ngIf="expenditureFormIndex === i || control.get(constants.FORM_CONTROL_NAMES.internalReferenceNumber).errors" jemsFormFieldWidth="full">
                                    <input #internalReferenceNumber
                                              [formControlName]="constants.FORM_CONTROL_NAMES.internalReferenceNumber"
                                              [matTooltip]="getLimitedTextInputTooltip(control.get(constants.FORM_CONTROL_NAMES.internalReferenceNumber).value, constants.MAX_LENGTH_INVOICE)"
                                              matInput>
                                    <mat-hint [jemsHintFor]="internalReferenceNumber">
                                        <jems-text-hint
                                                [currentLength]="lengthOfForm(control, constants.FORM_CONTROL_NAMES.internalReferenceNumber)"
                                                [maxLength]="constants.MAX_LENGTH_INVOICE"></jems-text-hint>
                                    </mat-hint>
                                    <mat-error>
                                        <jems-form-field-errors
                                                [errors]="control.errors"
                                                [messages]="constants.FORM_ERRORS.invoiceNumber"
                                                condensed="true">
                                        </jems-form-field-errors>
                                    </mat-error>
                                </mat-form-field>
                            </mat-cell>
                            <mat-footer-cell *matFooterCellDef></mat-footer-cell>
                        </ng-container>

                        <ng-container matColumnDef="invoiceNumber">
                            <mat-header-cell *matHeaderCellDef>
                                        <span jemsText
                                              maxLines="2">{{'project.application.partner.report.expenditures.tab.invoice.number' | translate}}</span>
                            </mat-header-cell>
                            <mat-cell *matCellDef="let control;  let i = index" [formGroupName]="i">
                                <div *ngIf="expenditureFormIndex !== i && !control.get(constants.FORM_CONTROL_NAMES.invoiceNumber).errors"
                                     (click)="selectRow(i, 'invoiceNumber')" class="custom-wrapper"
                                     [matTooltip]="getLimitedTextInputTooltip(control.get(constants.FORM_CONTROL_NAMES.invoiceNumber).value, constants.MAX_LENGTH_INVOICE)"
                                     [matTooltipClass]="'tooltip'"
                                     [ngClass]="getAdditionalRowClass(i, constants.FORM_CONTROL_NAMES.invoiceNumber)">
                                    <div class="custom-text-area">
                                        {{control.get(constants.FORM_CONTROL_NAMES.invoiceNumber).value}}
                                    </div>
                                </div>

                                <mat-form-field *ngIf="expenditureFormIndex === i || control.get(constants.FORM_CONTROL_NAMES.invoiceNumber).errors" jemsFormFieldWidth="full">
                                    <input #invoiceNumberInput
                                           [matTooltip]="getLimitedTextInputTooltip(control.get(constants.FORM_CONTROL_NAMES.invoiceNumber).value, constants.MAX_LENGTH_INVOICE)"
                                              [formControlName]="constants.FORM_CONTROL_NAMES.invoiceNumber"
                                              matInput>
                                    <mat-hint [jemsHintFor]="invoiceNumberInput">
                                        <jems-text-hint
                                                [currentLength]="lengthOfForm(control, constants.FORM_CONTROL_NAMES.invoiceNumber)"
                                                [maxLength]="constants.MAX_LENGTH_INVOICE"></jems-text-hint>
                                    </mat-hint>
                                    <mat-error>
                                        <jems-form-field-errors
                                                [errors]="control.errors"
                                                [messages]="constants.FORM_ERRORS.invoiceNumber"
                                                condensed="true">
                                        </jems-form-field-errors>
                                    </mat-error>
                                </mat-form-field>
                            </mat-cell>
                            <mat-footer-cell *matFooterCellDef></mat-footer-cell>
                        </ng-container>

                        <ng-container matColumnDef="invoiceDate">
                            <mat-header-cell *matHeaderCellDef>
                                        <span jemsText
                                              maxLines="2">{{'project.application.partner.report.expenditures.tab.invoice.date' | translate}}</span>
                            </mat-header-cell>
                            <mat-cell *matCellDef="let control;  let i = index" [formGroupName]="i">
                                <div *ngIf="expenditureFormIndex !== i && !control.get(constants.FORM_CONTROL_NAMES.invoiceDate).errors"
                                     class="custom-wrapper" [ngClass]="getAdditionalRowClass(i, constants.FORM_CONTROL_NAMES.invoiceDate)"
                                     (click)="selectRow(i, 'invoiceDate')">
                                    <div class="custom-text-area date">
                                        {{control.get(constants.FORM_CONTROL_NAMES.invoiceDate).value | localeDate : 'l' }}
                                    </div>
                                    <div class="custom-icon" (click)="selectRow(i, 'invoiceDatePicker')">
                                        <mat-icon class="calendar" [ngClass]="{'disabled': control.get(constants.FORM_CONTROL_NAMES.invoiceDate).disabled}">
                                            today
                                        </mat-icon>
                                    </div>
                                </div>

                                <mat-form-field *ngIf="expenditureFormIndex === i || control.get(constants.FORM_CONTROL_NAMES.invoiceDate).errors" jemsFormFieldWidth="full">
                                    <input name="invoiceDateForm"
                                           #invoiceDateInput
                                           [formControlName]="constants.FORM_CONTROL_NAMES.invoiceDate"
                                           matInput [matDatepicker]="invoiceDatePicker">
                                    <mat-datepicker-toggle matSuffix
                                                           [for]="invoiceDatePicker"></mat-datepicker-toggle>
                                    <mat-datepicker #invoiceDatePicker></mat-datepicker>
                                </mat-form-field>
                            </mat-cell>
                            <mat-footer-cell *matFooterCellDef></mat-footer-cell>
                        </ng-container>

                        <ng-container matColumnDef="dateOfPayment">
                            <mat-header-cell *matHeaderCellDef>
                                        <span jemsText
                                              maxLines="2">{{'project.application.partner.report.expenditures.tab.date.of.payment' | translate}}</span>
                            </mat-header-cell>
                            <mat-cell *matCellDef="let control;  let i = index" [formGroupName]="i">
                                <div *ngIf="expenditureFormIndex !== i && !control.get(constants.FORM_CONTROL_NAMES.dateOfPayment).errors"
                                     class="custom-wrapper" [ngClass]="getAdditionalRowClass(i, constants.FORM_CONTROL_NAMES.dateOfPayment)"
                                     (click)="selectRow(i, 'dateOfPayment')">
                                    <div class="custom-text-area date">
                                        {{control.get(constants.FORM_CONTROL_NAMES.dateOfPayment).value | localeDate : 'l'}}
                                    </div>
                                    <div class="custom-icon" (click)="selectRow(i, 'dateOfPaymentDatePicker')">
                                        <mat-icon class="calendar" [ngClass]="{'disabled': control.get(constants.FORM_CONTROL_NAMES.dateOfPayment).disabled}">
                                            today
                                        </mat-icon>
                                    </div>
                                </div>

                                <mat-form-field *ngIf="expenditureFormIndex === i || control.get(constants.FORM_CONTROL_NAMES.dateOfPayment).errors" jemsFormFieldWidth="full">
                                    <input name="dateOfPaymentForm"
                                           #dateOfPaymentInput
                                           [formControlName]="constants.FORM_CONTROL_NAMES.dateOfPayment"
                                           matInput [matDatepicker]="dateOfPaymentPicker">
                                    <mat-datepicker-toggle matSuffix
                                                           [for]="dateOfPaymentPicker"></mat-datepicker-toggle>
                                    <mat-datepicker #dateOfPaymentPicker></mat-datepicker>
                                </mat-form-field>
                            </mat-cell>
                            <mat-footer-cell *matFooterCellDef></mat-footer-cell>
                        </ng-container>

                        <ng-container matColumnDef="description">
                            <mat-header-cell *matHeaderCellDef>
                                <span jemsText
                                      maxLines="2">{{'project.application.partner.report.expenditures.tab.description' | translate}}</span>
                                <span>
                                    <mat-icon
                                            matTooltip="{{'project.application.partner.report.expenditures.tab.cost.field.sensitive.info' | translate}}">
                                        privacy_tip
                                    </mat-icon>
                                </span>
                            </mat-header-cell>
                            <mat-cell *matCellDef="let control;  let i = index" [formGroupName]="i">
                                <div *ngIf="expenditureFormIndex !== i && !control.get(constants.FORM_CONTROL_NAMES.description).errors"
                                     (click)="selectRow(i, 'description')" class="custom-wrapper"
                                     [matTooltip]="getLimitedTextInputTooltip(control.get(constants.FORM_CONTROL_NAMES.description).value | translateByInputLanguage | async, constants.MAX_LENGTH)"
                                     [matTooltipClass]="'tooltip'"
                                     [ngClass]="getAdditionalRowClass(i, constants.FORM_CONTROL_NAMES.description)">
                                    <div class="custom-text-area">
                                        {{control.get(constants.FORM_CONTROL_NAMES.description).value | translateByInputLanguage | async}}
                                    </div>
                                </div>

                                <ng-container>
                                    <jems-multi-language-form-field
                                            *ngIf="expenditureFormIndex === i || control.get(constants.FORM_CONTROL_NAMES.description).errors"
                                            #descriptionInput
                                            type="input"
                                            condensed="true"
                                            [hasFocus]="descriptionInputPressed"
                                            [formControlName]="constants.FORM_CONTROL_NAMES.description"
                                            [maxLength]="constants.MAX_LENGTH">
                                    </jems-multi-language-form-field>
                                </ng-container>
                            </mat-cell>
                            <mat-footer-cell *matFooterCellDef></mat-footer-cell>
                        </ng-container>

                        <ng-container matColumnDef="comment">
                            <mat-header-cell *matHeaderCellDef>
                                <span jemsText
                                      maxLines="2">{{'project.application.partner.report.expenditures.tab.comment' | translate}}</span>
                                <span>
                                    <mat-icon
                                            matTooltip="{{'project.application.partner.report.expenditures.tab.cost.field.sensitive.info' | translate}}">
                                        privacy_tip
                                    </mat-icon>
                                </span>
                            </mat-header-cell>
                            <mat-cell *matCellDef="let control;  let i = index" [formGroupName]="i">
                                <div *ngIf="expenditureFormIndex !== i && !control.get(constants.FORM_CONTROL_NAMES.comment).errors"
                                     (click)="selectRow(i, 'comment')" class="custom-wrapper"
                                     [matTooltip]="getLimitedTextInputTooltip(control.get(constants.FORM_CONTROL_NAMES.comment).value | translateByInputLanguage | async, constants.MAX_LENGTH)"
                                     [matTooltipClass]="'tooltip'"
                                     [ngClass]="getAdditionalRowClass(i, constants.FORM_CONTROL_NAMES.comment)">
                                    <div class="custom-text-area">
                                        {{control.get(constants.FORM_CONTROL_NAMES.comment).value | translateByInputLanguage | async}}
                                    </div>
                                </div>

                                <ng-container>
                                    <jems-multi-language-form-field
                                            *ngIf="expenditureFormIndex === i || control.get(constants.FORM_CONTROL_NAMES.comment).errors"
                                            #commentInput
                                            type="input"
                                            condensed="true"
                                            [title]="commentInput.label"
                                            [hasFocus]="commentInputPressed"
                                            [formControlName]="constants.FORM_CONTROL_NAMES.comment"
                                            [maxLength]="constants.MAX_LENGTH">
                                    </jems-multi-language-form-field>
                                </ng-container>
                            </mat-cell>
                            <mat-footer-cell *matFooterCellDef></mat-footer-cell>
                        </ng-container>
                        <ng-container matColumnDef="totalValueInvoice">
                            <mat-header-cell class="end-flex-header-table" *matHeaderCellDef>
                                        <span jemsText
                                              maxLines="2">{{'project.application.partner.report.expenditures.tab.total.value.invoice' | translate}}</span>
                            </mat-header-cell>
                            <mat-cell *matCellDef="let control;  let i = index" [formGroupName]="i">
                                <div *ngIf="expenditureFormIndex !== i && !control.get(constants.FORM_CONTROL_NAMES.totalValueInvoice).errors"
                                     (click)="selectRow(i, 'totalValueInvoice')" class="custom-wrapper align-right"
                                     [ngClass]="getAdditionalRowClass(i, constants.FORM_CONTROL_NAMES.totalValueInvoice)">
                                    <div class="custom-text-area">
                                        {{(control.get(constants.FORM_CONTROL_NAMES.totalValueInvoice).value || 0) | asMoney}}
                                    </div>
                                </div>

                                <mat-form-field *ngIf="expenditureFormIndex === i || control.get(constants.FORM_CONTROL_NAMES.totalValueInvoice).errors" jemsFormFieldWidth="full">
                                    <input [formControlName]="constants.FORM_CONTROL_NAMES.totalValueInvoice"
                                           [options]="{min: constants.NEGATIVE_MIN_VALUE, max: constants.MAX_VALUE, align: 'right', allowNegative: true}"
                                           currencyMask matInput
                                           type="decimal" #totalValueInvoiceInput>
                                </mat-form-field>
                            </mat-cell>
                            <mat-footer-cell *matFooterCellDef></mat-footer-cell>
                        </ng-container>

                        <ng-container matColumnDef="vat">
                            <mat-header-cell class="end-flex-header-table" *matHeaderCellDef>
                                        <span jemsText
                                              maxLines="2">{{'project.application.partner.report.expenditures.tab.vat' | translate}}</span>
                            </mat-header-cell>
                            <mat-cell *matCellDef="let control;  let i = index" [formGroupName]="i">
                                <div *ngIf="expenditureFormIndex !== i && !control.get(constants.FORM_CONTROL_NAMES.vat).errors"
                                     (click)="selectRow(i, 'vat')" class="custom-wrapper align-right"
                                     [ngClass]="getAdditionalRowClass(i, constants.FORM_CONTROL_NAMES.vat)">
                                    <div class="custom-text-area">
                                        {{(control.get(constants.FORM_CONTROL_NAMES.vat).value || 0)  | asMoney}}
                                    </div>
                                </div>

                                <mat-form-field *ngIf="expenditureFormIndex === i || control.get(constants.FORM_CONTROL_NAMES.vat).errors" jemsFormFieldWidth="full">
                                    <input [formControlName]="constants.FORM_CONTROL_NAMES.vat"
                                           [options]="{min: constants.MIN_VALUE, max: constants.MAX_VALUE, align: 'right'}"
                                           currencyMask matInput
                                           type="decimal" #vatInput>
                                </mat-form-field>
                            </mat-cell>
                            <mat-footer-cell *matFooterCellDef></mat-footer-cell>
                        </ng-container>

                        <ng-container matColumnDef="numberOfUnits">
                            <mat-header-cell class="end-flex-header-table" *matHeaderCellDef>
                                        <span jemsText
                                              maxLines="2" class="align-right">{{'project.application.partner.report.expenditures.tab.number.of.units' | translate}}</span>
                            </mat-header-cell>
                            <mat-cell *matCellDef="let control;  let i = index" [formGroupName]="i">
                                <div *ngIf="control.get(constants.FORM_CONTROL_NAMES.costOptions).value && (expenditureFormIndex !== i && !control.get(constants.FORM_CONTROL_NAMES.numberOfUnits).errors)"
                                     (click)="selectRow(i, 'numberOfUnits')" class="custom-wrapper align-right"
                                     [ngClass]="getAdditionalRowClass(i, constants.FORM_CONTROL_NAMES.numberOfUnits)">
                                    <div class="custom-text-area">
                                        {{control.get(constants.FORM_CONTROL_NAMES.numberOfUnits).value | asMoney}}
                                    </div>
                                </div>

                                <mat-form-field jemsFormFieldWidth="full" *ngIf="control.get(constants.FORM_CONTROL_NAMES.costOptions).value && (expenditureFormIndex === i || control.get(constants.FORM_CONTROL_NAMES.numberOfUnits).errors)" (keyup)="onUpdateNumberOfUnits(i)">
                                    <input [formControlName]="constants.FORM_CONTROL_NAMES.numberOfUnits"
                                           [options]="{align:'right'}"
                                           matInput
                                           currencyMask
                                           type="decimal" #numberOfUnitsInput>
                                </mat-form-field>
                            </mat-cell>
                            <mat-footer-cell *matFooterCellDef></mat-footer-cell>
                        </ng-container>

                        <ng-container matColumnDef="pricePerUnit">
                            <mat-header-cell class="end-flex-header-table" *matHeaderCellDef>
                                        <span jemsText
                                              maxLines="2">{{'project.application.partner.report.expenditures.tab.price.per.unit' | translate}}</span>
                            </mat-header-cell>
                            <mat-cell *matCellDef="let control;  let i = index" [formGroupName]="i">
                                <div *ngIf="control.get(constants.FORM_CONTROL_NAMES.costOptions).value && (expenditureFormIndex !== i && !control.get(constants.FORM_CONTROL_NAMES.pricePerUnit).errors)"
                                     (click)="selectRow(i, 'pricePerUnit')" class="custom-wrapper align-right"
                                     [ngClass]="getAdditionalRowClass(i, constants.FORM_CONTROL_NAMES.pricePerUnit)">
                                    <div class="custom-text-area" >
                                        {{control.get(constants.FORM_CONTROL_NAMES.pricePerUnit).value | asMoney}}
                                    </div>
                                </div>

                                <mat-form-field jemsFormFieldWidth="full" *ngIf="control.get(constants.FORM_CONTROL_NAMES.costOptions).value && (expenditureFormIndex === i || control.get(constants.FORM_CONTROL_NAMES.pricePerUnit).errors)">
                                    <input [formControlName]="constants.FORM_CONTROL_NAMES.pricePerUnit"
                                           [options]="{min: constants.MIN_VALUE, max: constants.MAX_VALUE, align: 'right'}"
                                           currencyMask matInput
                                           type="decimal" #pricePerUnitInput>
                                </mat-form-field>
                            </mat-cell>
                            <mat-footer-cell *matFooterCellDef></mat-footer-cell>
                        </ng-container>
                        <ng-container matColumnDef="declaredAmount">
                            <mat-header-cell class="end-flex-header-table" *matHeaderCellDef>
                                        <span jemsText
                                              maxLines="2">{{'project.application.partner.report.expenditures.declared.amount' | translate}}</span>
                            </mat-header-cell>
                            <mat-cell *matCellDef="let control;  let i = index" [formGroupName]="i">
                                <div *ngIf="expenditureFormIndex !== i && !control.get(constants.FORM_CONTROL_NAMES.declaredAmount).errors"
                                     (click)="selectRow(i, 'declaredAmount')" class="custom-wrapper align-right"
                                     [ngClass]="getAdditionalRowClass(i, constants.FORM_CONTROL_NAMES.declaredAmount)">
                                    <div class="custom-text-area" >
                                        {{control.get(constants.FORM_CONTROL_NAMES.declaredAmount).value | asMoney}}
                                    </div>
                                </div>

                                <mat-form-field *ngIf="expenditureFormIndex === i || control.get(constants.FORM_CONTROL_NAMES.declaredAmount).errors" jemsFormFieldWidth="full">
                                    <input [formControlName]="constants.FORM_CONTROL_NAMES.declaredAmount"
                                           [options]="{min: constants.NEGATIVE_MIN_VALUE, max: constants.MAX_VALUE, align: 'right', allowNegative: true}"
                                           (keyup)="updateAmountInEur(i, control.value.declaredAmount)"
                                           currencyMask matInput #declaredAmountInput
                                           type="decimal">
                                </mat-form-field>
                            </mat-cell>
                            <mat-footer-cell *matFooterCellDef></mat-footer-cell>
                        </ng-container>
                        <ng-container matColumnDef="currencyCode">
                            <mat-header-cell *matHeaderCellDef>
                                        <span jemsText
                                              maxLines="2">{{'project.application.partner.report.expenditures.currency' | translate}}</span>
                            </mat-header-cell>
                            <mat-cell *matCellDef="let control;  let i = index" (click)="selectRow(i, 'currencyCode')" [formGroupName]="i">
                                <div *ngIf="expenditureFormIndex !== i && !control.get(constants.FORM_CONTROL_NAMES.currencyCode).errors"
                                     class="custom-wrapper pointer" [ngClass]="getAdditionalRowClass(i, constants.FORM_CONTROL_NAMES.currencyCode)">
                                    <div class="custom-dropdown-text">
                                        {{control.get(constants.FORM_CONTROL_NAMES.currencyCode).value}}
                                    </div>
                                    <div *ngIf="!control.get(constants.FORM_CONTROL_NAMES.currencyCode).disabled && !hasPartnerCurrencySetToEur()" class="custom-icon">
                                        <mat-icon class="arrow">arrow_drop_down</mat-icon>
                                    </div>
                                </div>

                                <mat-form-field *ngIf="expenditureFormIndex === i || control.get(constants.FORM_CONTROL_NAMES.currencyCode).errors" jemsFormFieldWidth="full">
                                    <mat-select class="placeholder-required"
                                                #currencyCodeSelect
                                                [disabled]="hasPartnerCurrencySetToEur()"
                                                [formControlName]="constants.FORM_CONTROL_NAMES.currencyCode"
                                                [required]="true"
                                                placeholder="{{'project.application.partner.report.expenditures.currency.placeholder' | translate}}"
                                                (selectionChange)="onCurrencyChange(i, $event)">
                                        <mat-option *ngFor="let currency of availableCurrenciesPerRow[i]" [value]="currency.code">{{currency.code}}</mat-option>
                                    </mat-select>
                                </mat-form-field>
                            </mat-cell>
                            <mat-footer-cell *matFooterCellDef></mat-footer-cell>
                        </ng-container>
                        <ng-container matColumnDef="currencyConversionRate">
                            <mat-header-cell class="end-flex-header-table justify-end" *matHeaderCellDef>
                                        <span jemsText
                                              maxLines="2">{{'project.application.partner.report.expenditures.conversion.rate' | translate}}</span>
                            </mat-header-cell>
                            <mat-cell *matCellDef="let control;  let i = index" [formGroupName]="i">
                                <div *ngIf="expenditureFormIndex !== i" class="custom-wrapper align-right border-with-dotted">
                                    <div class="custom-text-area">
                                        {{control.get(constants.FORM_CONTROL_NAMES.currencyConversionRate).value}}
                                    </div>
                                </div>

                                <mat-form-field *ngIf="expenditureFormIndex === i" jemsFormFieldWidth="full" [class.mat-form-field-disabled]="true">
                                    <input class="text-right" [formControlName]="constants.FORM_CONTROL_NAMES.currencyConversionRate"
                                           [readonly]="true"
                                           matInput>
                                </mat-form-field>
                            </mat-cell>
                            <mat-footer-cell *matFooterCellDef></mat-footer-cell>
                        </ng-container>

                        <ng-container matColumnDef="declaredAmountInEur" >
                            <mat-header-cell class="justify-end" *matHeaderCellDef>
                                <span jemsText maxLines="2">
                                    {{'project.application.partner.report.expenditures.declared.amount.eur' | translate}}
                                    <jems-context-info infoPosition="right"
                                                       infoText="{{'project.application.partner.report.expenditures.amount.in.euro.info' | translate}}">
                                    </jems-context-info>
                                </span>
                            </mat-header-cell>
                            <mat-cell *matCellDef="let control;  let i = index" [formGroupName]="i">
                                <div *ngIf="expenditureFormIndex !== i" class="custom-wrapper align-right border-with-dotted">
                                    <div class="custom-text-area" >
                                        {{control.get(constants.FORM_CONTROL_NAMES.declaredAmountInEur).value | asMoney}}
                                    </div>
                                </div>

                                <mat-form-field *ngIf="expenditureFormIndex === i" jemsFormFieldWidth="full" [class.mat-form-field-disabled]="true">
                                    <input [formControlName]="constants.FORM_CONTROL_NAMES.declaredAmountInEur"
                                           [readonly]="true"
                                           [options]="{align: 'right', allowNegative: true}"
                                           currencyMask matInput
                                           type="decimal">
                                </mat-form-field>

                            </mat-cell>
                            <mat-footer-cell *matFooterCellDef></mat-footer-cell>
                        </ng-container>

                        <ng-container matColumnDef="uploadFunction">
                            <mat-header-cell *matHeaderCellDef>{{'project.application.partner.report.attachments' | translate}}
                                <span>
                                    <mat-icon
                                            matTooltip="{{'project.application.partner.report.expenditures.tab.cost.field.sensitive.info' | translate}}">
                                        privacy_tip
                                    </mat-icon>
                                </span>
                            </mat-header-cell>
                            <mat-cell class="justify-start" *matCellDef="let control;let expenditureIndex=index" [formGroupName]="expenditureIndex" >
                                <jems-partner-actions-cell
                                        *ngIf="control.get('id').value"
                                        [formControlName]="constants.FORM_CONTROL_NAMES.attachment"
                                        [isReportEditable]="editAllowed(control.get(constants.FORM_CONTROL_NAMES.costGDPR).value, data.isGDPRCompliant, data.canEdit, data.isMonitorUser) && data.isReportEditable"
                                        [isUploadDone]="isUploadDone"
                                        (upload)="onUploadFileToExpenditure($event, control.get('id').value, expenditureIndex)"
                                        (download)="onDownloadFile($event)"
                                        (delete)="onDeleteFile($event, expenditureIndex)">
                                </jems-partner-actions-cell>
                            </mat-cell>
                            <mat-footer-cell *matFooterCellDef></mat-footer-cell>
                        </ng-container>

                        <ng-container matColumnDef="actions" stickyEnd>
                            <mat-header-cell *matHeaderCellDef></mat-header-cell>
                            <mat-cell *matCellDef="let control;let index=index" class="justify-end">
                                <button mat-icon-button *ngIf="reportExpendituresForm.enabled"
                                        [disabled]="!!control.get('attachment').value ||
                                        !data.isReportEditable ||
                                        data.isReopenedLast ||
                                        data.isReopenedLimited ||
                                        !deleteAllowed(control.get(constants.FORM_CONTROL_NAMES.costGDPR).value, data.isGDPRCompliant, data.canEdit)"
                                        (click)="removeItem(index)"
                                        class="delete-button"
                                        color="accent"
                                        tabindex="-1"
                                        type="button"
                                        aria-label="delete">
                                    <mat-icon *ngIf="editAllowed(control.get(constants.FORM_CONTROL_NAMES.costGDPR).value, data.isGDPRCompliant, data.canEdit, data.isMonitorUser)"
                                            matTooltip="{{ (attachment(index).value ? 'project.application.partner.report.attachment.delete.file.first' : null) | translate }}">
                                        {{ attachment(index).value ? 'delete_forever' : 'delete'}}
                                    </mat-icon>
                                </button>
                            </mat-cell>
                            <mat-footer-cell *matFooterCellDef></mat-footer-cell>
                        </ng-container>

                        <mat-header-row *matHeaderRowDef="data.columnsToDisplay; sticky:true"></mat-header-row>
                        <mat-row *matRowDef="let myRowData; columns: data.columnsToDisplay; let rowIndex =index"
                                 [class.row-has-error]="items.controls[rowIndex]?.invalid"></mat-row>

                    </mat-table>
                </jems-multi-language-container>
            </div>
            <button *ngIf="data.isReportEditable && !data.isReopenedLast && !data.isReopenedLimited"
                    mat-stroked-button type="button" class="mt-2"
                    [disabled]="items.length >= constants.MAX_NUMBER_OF_ITEMS"
                    (click)="addNewItem()"
                    aria-label="add">
                <mat-icon>add</mat-icon>
                <span>&nbsp;{{'project.application.partner.report.expenditures.tab.button.add' | translate}}</span>
            </button>
        </form>

        <jems-partner-report-expenditures-parked
                *ngIf="data.parkedExpenditures.length && data.isReportEditable && !data.isReopenedLimited"
                [listDirty$]="formService.dirty$"
                [expenditures]="data.parkedExpenditures"
                [columns]="data.columnsToDisplay">
        </jems-partner-report-expenditures-parked>

    </jems-form>
</div>
