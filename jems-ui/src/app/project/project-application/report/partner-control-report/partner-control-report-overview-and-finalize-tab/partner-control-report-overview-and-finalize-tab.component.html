<jems-form *ngIf="data$ | async as data" [formGroup]="overviewForm"
           (discard)="resetForm(data.controlReportOverview)"
           (save)="saveForm(data.partnerId, data.reportId)">
    <h3>{{'project.application.partner.report.control.tab.overviewAndFinalize.title' | translate}}</h3>
    <p>{{'project.application.partner.report.control.tab.overviewAndFinalize.info' | translate}}</p>
    <mat-table jemsNoWidthLimit
               [jemsTableConfig]="[{minInRem: 8, maxInRem: 14}, {minInRem: 8, maxInRem: 14}, {minInRem: 8, maxInRem: 13}, {minInRem: 8, maxInRem: 14}, {minInRem: 8, maxInRem: 14}, {minInRem: 8, maxInRem: 14}, {minInRem: 8, maxInRem: 13}]"
               [dataSource]="data.dataSource">
        <ng-container matColumnDef="declaredByPartner">
            <mat-header-cell mat-header-cell *matHeaderCellDef>
                <span jemsText>{{ 'project.application.partner.report.control.tab.overviewAndFinalize.total.declared.partner' | translate }}</span>
            </mat-header-cell>
            <mat-cell *matCellDef="let element"> {{element.declaredByPartner | asMoney}}</mat-cell>
        </ng-container>

        <ng-container matColumnDef="inControlSample">
            <mat-header-cell *matHeaderCellDef>
                <span jemsText>{{ 'project.application.partner.report.control.tab.overviewAndFinalize.total.included.control.sample' | translate }}</span>
            </mat-header-cell>
            <mat-cell *matCellDef="let element"> {{element.inControlSample | asMoney }} </mat-cell>
        </ng-container>

        <ng-container matColumnDef="inControlSamplePercentage">
            <mat-header-cell *matHeaderCellDef>
                <span jemsText>{{ 'project.application.partner.report.control.tab.overviewAndFinalize.total.included.control.sample.percentage' | translate }}</span>
            </mat-header-cell>
            <mat-cell *matCellDef="let element"> {{element.inControlSamplePercentage | asMoney}}%</mat-cell>
        </ng-container>

        <ng-container matColumnDef="parked">
            <mat-header-cell *matHeaderCellDef>
                <span jemsText>
                    {{ 'project.application.partner.report.control.tab.overviewAndFinalize.total.parked.current.report' | translate }}
                    <jems-context-info infoPosition="right"
                                       infoText="{{'project.application.partner.report.control.tab.overviewAndFinalize.total.parked.info' | translate}}">
                    </jems-context-info>
                </span>
            </mat-header-cell>
            <mat-cell *matCellDef="let element"> {{element.parked | asMoney }}</mat-cell>
        </ng-container>

        <ng-container matColumnDef="deductedByControl">
            <mat-header-cell *matHeaderCellDef>
                <span jemsText>{{ 'project.application.partner.report.control.tab.overviewAndFinalize.total.deducted.by.control' | translate }}</span>
            </mat-header-cell>
            <mat-cell *matCellDef="let element"> {{element.deductedByControl | asMoney}} </mat-cell>
        </ng-container>

        <ng-container matColumnDef="eligibleAfterControl">
            <mat-header-cell *matHeaderCellDef>
                <span jemsText>{{ 'project.application.partner.report.control.tab.overviewAndFinalize.total.eligible.after.control' | translate }}</span>
            </mat-header-cell>
            <mat-cell *matCellDef="let element"> {{element.eligibleAfterControl | asMoney}} </mat-cell>
        </ng-container>

        <ng-container matColumnDef="eligibleAfterControlPercentage">
            <mat-header-cell *matHeaderCellDef>
                <span jemsText>{{ 'project.application.partner.report.control.tab.overviewAndFinalize.total.percentage' | translate }}</span>
            </mat-header-cell>
            <mat-cell *matCellDef="let element"> {{element.eligibleAfterControlPercentage | asMoney}}%</mat-cell>
        </ng-container>

        <mat-header-row *matHeaderRowDef="displayedColumns"></mat-header-row>
        <mat-row *matRowDef="let row; columns: displayedColumns"></mat-row>
    </mat-table>

    <h3>{{'project.application.partner.report.control.tab.overviewAndFinalize.deductions.by.type.of.errors' | translate}}</h3>
    <p>{{'project.application.partner.report.control.tab.overviewAndFinalize.deductions.by.type.of.errors.info' | translate}}</p>

    <div *ngIf="deductionOverview$ | async as deductionOverview">
        <mat-table jemsNoWidthLimit [dataSource]="deductionOverview.dataSource" >
            <ng-container matColumnDef="typeOfErrors" sticky>
                <mat-header-cell *matHeaderCellDef>
                    <span jemsText maxLines="2">{{ 'project.application.partner.report.control.tab.overviewAndFinalize.deductions.by.type.table.type.header' | translate }}</span>
                </mat-header-cell>
                <mat-cell *matCellDef="let line">{{ line.typologyOfErrorName || ('project.application.partner.report.control.tab.overviewAndFinalize.deductions.by.type.table.flat.rate.row' | translate)}}</mat-cell>
                <mat-footer-cell *matFooterCellDef>{{ 'project.partner.budget.table.total' | translate }}</mat-footer-cell>
            </ng-container>

            <ng-container matColumnDef="staffCosts">
                <mat-header-cell *matHeaderCellDef class="justify-center header-flat-rate-container">
                    <span jemsText class="respect-line-break" maxLines="2">{{ 'project.application.partner.report.expenditures.cost.category.StaffCosts' | translate }}</span>
                    <span  class="flat-rate-percentage" *ngIf="deductionOverview.data.staffCostsFlatRate">{{deductionOverview.data.staffCostsFlatRate}}%</span>
                </mat-header-cell>
                <mat-cell *matCellDef="let line" class="justify-center"><span>{{ line.staffCost | asMoney}}</span></mat-cell>
                <mat-footer-cell *matFooterCellDef class="justify-center">{{ deductionOverview.data.total.staffCost | asMoney }}</mat-footer-cell>
            </ng-container>

            <ng-container matColumnDef="officeAndAdministration">
                <mat-header-cell *matHeaderCellDef class="text-right header-flat-rate-container">
                    <div jemsText maxLines="2" class="respect-line-break">{{ 'project.application.partner.report.control.tab.overviewAndFinalize.deductions.by.type.table.office.administrative.header' | translate }}</div>
                    <div class="flat-rate-percentage" >
                        <span  *ngIf="deductionOverview.data.officeAndAdministrationFlatRate">{{deductionOverview.data.officeAndAdministrationFlatRate}}%</span>
                    </div>
                </mat-header-cell>
                <mat-cell *matCellDef="let line" class="text-right"><span>{{ line.officeAndAdministration | asMoney }}</span></mat-cell>
                <mat-footer-cell *matFooterCellDef class="text-right">{{deductionOverview.data.total.officeAndAdministration | asMoney }}</mat-footer-cell>
            </ng-container>


            <ng-container matColumnDef="travelAndAccommodation">
                <mat-header-cell *matHeaderCellDef class="text-right header-flat-rate-container">
                    <div jemsText maxLines="2" class="respect-line-break">{{ 'project.application.partner.report.expenditures.cost.category.TravelAndAccommodationCosts' | translate }} </div>
                    <div class="flat-rate-percentage">
                        <span *ngIf="deductionOverview.data.travelAndAccommodationFlatRate">{{deductionOverview.data.travelAndAccommodationFlatRate}}%</span>
                    </div>
                </mat-header-cell>
                <mat-cell *matCellDef="let line" class="text-right"><span>{{ line.travelAndAccommodation | asMoney }}</span></mat-cell>
                <mat-footer-cell *matFooterCellDef class="text-right">{{deductionOverview.data.total.travelAndAccommodation | asMoney }}</mat-footer-cell>
            </ng-container>

            <ng-container matColumnDef="externalExpertise">
                <mat-header-cell *matHeaderCellDef class="text-right">
                    <span jemsText maxLines="2">{{ 'project.application.partner.report.expenditures.cost.category.ExternalCosts' | translate }}</span>
                </mat-header-cell>
                <mat-cell *matCellDef="let line" class="text-right">{{ line.externalExpertise | asMoney }}</mat-cell>
                <mat-footer-cell *matFooterCellDef class="text-right">{{ deductionOverview.data.total.externalExpertise | asMoney }}</mat-footer-cell>
            </ng-container>

            <ng-container matColumnDef="equipment">
                <mat-header-cell *matHeaderCellDef class="text-right">
                    <span jemsText maxLines="2">{{ 'project.application.partner.report.expenditures.cost.category.EquipmentCosts' | translate }}</span>
                </mat-header-cell>
                <mat-cell *matCellDef="let line" class="text-right">{{ line.equipment | asMoney }}</mat-cell>
                <mat-footer-cell *matFooterCellDef class="text-right">{{ deductionOverview.data.total.equipment | asMoney }}</mat-footer-cell>
            </ng-container>

            <ng-container matColumnDef="infrastructure">
                <mat-header-cell *matHeaderCellDef class="text-right">
                    <span jemsText maxLines="2">{{ 'project.application.partner.report.expenditures.cost.category.InfrastructureCosts' | translate }}</span>
                </mat-header-cell>
                <mat-cell *matCellDef="let line" class="text-right">{{ line.infrastructureAndWorks | asMoney }}</mat-cell>
                <mat-footer-cell *matFooterCellDef class="text-right">{{ deductionOverview.data.total.infrastructureAndWorks | asMoney }}</mat-footer-cell>
            </ng-container>

            <ng-container matColumnDef="lumpSums">
                <mat-header-cell *matHeaderCellDef class="text-right">
                    <span jemsText maxLines="2">{{ 'project.application.partner.report.control.tab.overviewAndFinalize.deductions.by.type.table.lump.sums.header' | translate }}</span>
                </mat-header-cell>
                <mat-cell *matCellDef="let line" class="text-right">{{ line.lumpSums | asMoney }}</mat-cell>
                <mat-footer-cell *matFooterCellDef class="text-right">{{ deductionOverview.data.total.lumpSums | asMoney }}</mat-footer-cell>
            </ng-container>

            <ng-container matColumnDef="unitCosts">
                <mat-header-cell *matHeaderCellDef class="text-right">
                    <span jemsText maxLines="2">{{ 'project.application.partner.report.control.tab.overviewAndFinalize.deductions.by.type.table.unit.costs.header' | translate }}</span>
                </mat-header-cell>
                <mat-cell *matCellDef="let line" class="text-right">{{ line.unitCosts | asMoney }}</mat-cell>
                <mat-footer-cell *matFooterCellDef class="text-right">{{ deductionOverview.data.total.unitCosts | asMoney }}</mat-footer-cell>
            </ng-container>

            <ng-container matColumnDef="otherCosts">
                <mat-header-cell *matHeaderCellDef class="text-right header-flat-rate-container">
                    <div jemsText maxLines="2">{{ 'project.partner.budget.other' | translate }}</div>
                    <div class="flat-rate-percentage">
                        <span *ngIf="deductionOverview.data.otherCostsOnStaffCostsFlatRate">{{deductionOverview.data.otherCostsOnStaffCostsFlatRate}}%</span>
                    </div>
                </mat-header-cell>
                <mat-cell *matCellDef="let line" class="text-right"> <span>{{ line.otherCosts | asMoney }}</span></mat-cell>
                <mat-footer-cell *matFooterCellDef class="text-right">{{ deductionOverview.data.total.otherCosts | asMoney }}</mat-footer-cell>
            </ng-container>

            <ng-container matColumnDef="total">
                <mat-header-cell *matHeaderCellDef class="text-right">
                    <span jemsText maxLines="2">{{ 'project.partner.budget.table.total' | translate }}</span>
                </mat-header-cell>
                <mat-cell *matCellDef="let line" class="text-right">{{ line.total | asMoney }}</mat-cell>
                <mat-footer-cell *matFooterCellDef class="text-right">{{ deductionOverview.data.total.total | asMoney }}</mat-footer-cell>
            </ng-container>

            <mat-header-row *matHeaderRowDef="deductionOverviewDisplayedColumns"></mat-header-row>
            <mat-row *matRowDef="let row; columns: deductionOverviewDisplayedColumns"></mat-row>
            <mat-footer-row *matFooterRowDef="deductionOverviewDisplayedColumns"></mat-footer-row>

        </mat-table>
    </div>

    <h3>{{'project.application.partner.report.control.tab.overviewAndFinalize.control.timing' | translate}}</h3>
    <p>{{'project.application.partner.report.control.tab.overviewAndFinalize.control.timing.info' | translate}}</p>
    <mat-form-field class="date" jemsFormFieldWidth="x-large">
        <mat-label>{{'project.application.partner.report.control.tab.overviewAndFinalize.control.timing.start.date' | translate}}</mat-label>
        <input class="date-picker" formControlName="controlWorkStartDate" matInput [matDatepicker]="controlWorkStartDate" required>
        <mat-datepicker-toggle matSuffix [for]="controlWorkStartDate"></mat-datepicker-toggle>
        <mat-datepicker #controlWorkStartDate></mat-datepicker>
        <mat-error>
            <jems-form-field-errors
                    [errors]="overviewForm?.controls?.controlWorkStartDate?.errors" [condensed]="true">
            </jems-form-field-errors>
        </mat-error>
    </mat-form-field>

    <div>
        <br>
        {{'project.application.partner.report.control.tab.overviewAndFinalize.control.timing.clarification.requests.dates' | translate}}
        <jems-expandable-textarea jemsMultiColumnRow class="w-50"
                                  [control]="overviewForm?.controls?.requestsForClarifications"
                                  [errors]="overviewForm?.controls?.requestsForClarifications.errors"
                                  [characterLimit]="1000"
                                  [minRows]="1"
                                  [maxRows]="15">
        </jems-expandable-textarea>
    </div>

    <div>
        <br>
        {{'project.application.partner.report.control.tab.overviewAndFinalize.control.timing.satisfactory.answers.dates' | translate}}
        <jems-expandable-textarea jemsMultiColumnRow class="w-50"
                                  [control]="overviewForm?.controls?.receiptOfSatisfactoryAnswers"
                                  [errors]="overviewForm?.controls?.receiptOfSatisfactoryAnswers.errors"
                                  [characterLimit]="1000"
                                  [minRows]="1"
                                  [maxRows]="15">

        </jems-expandable-textarea>
    </div>

    <mat-form-field class="date" jemsFormFieldWidth="x-large">
        <mat-label>{{'project.application.partner.report.control.tab.overviewAndFinalize.control.timing.end.date' | translate}}</mat-label>
        <input class="date-picker" formControlName="controlWorkEndDate" matInput [matDatepicker]="controlWorkEndDate" disabled>
        <mat-datepicker #controlWorkEndDate></mat-datepicker>
    </mat-form-field>

    <h3>{{'project.application.partner.report.control.tab.overviewAndFinalize.findings.observations.limitations.title' | translate}}</h3>
    <p>{{'project.application.partner.report.control.tab.overviewAndFinalize.findings.observations.limitations.info' | translate}}</p>
    <jems-expandable-textarea jemsMultiColumnRow class="w-50"
                              [control]="overviewForm?.controls?.findingDescription"
                              [errors]="overviewForm?.controls?.findingDescription.errors"
                              [characterLimit]="5000"
                              [minRows]="1"
                              [maxRows]="15">
    </jems-expandable-textarea>
    <br>
    <div *ngIf="!overviewForm.controls.lastCertifiedReportNumber.value">
        <h3>{{'project.application.partner.report.control.tab.overviewAndFinalize.followup.measures.title' | translate}}</h3>
    </div>

    <div *ngIf="overviewForm.controls.lastCertifiedReportNumber.value">
        <h3>{{'project.application.partner.report.control.tab.overviewAndFinalize.followup.measures.with.report.num.title' | translate : {reportNumber: overviewForm.controls.lastCertifiedReportNumber.value} }}</h3>
    </div>

    <div *ngIf="overviewForm?.controls?.previousFollowUpMeasuresFromLastReport.value && !overviewForm.controls.controlWorkEndDate.value">
        <jems-alert [show]="overviewForm.controls.changedLastCertifiedReportEndDate.value"
                    [type]="Alert.WARNING">
            <span>{{'project.application.partner.report.control.tab.overviewAndFinalize.followup.measures.previous.changed.info' | translate : { dateInfo: getDateInfo(overviewForm.controls.changedLastCertifiedReportEndDate.value)} }}</span>
        </jems-alert>
        <jems-expandable-textarea jemsMultiColumnRow class="w-50"
                                  [control]="overviewForm?.controls?.previousFollowUpMeasuresFromLastReport"
                                  [disabled] = "true"
                                  [characterLimit]="5000"
                                  [minRows]="1"
                                  [maxRows]="15">
        </jems-expandable-textarea>
    </div>

    <jems-alert show="true" *ngIf="!overviewForm?.controls?.previousFollowUpMeasuresFromLastReport.value && !overviewForm.controls.controlWorkEndDate.value" [type]="Alert.WARNING" [closable]="true">
        <span>{{'project.application.partner.report.control.tab.overviewAndFinalize.followup.measures.no.previous.info' | translate}}</span>
    </jems-alert>
    <p>{{'project.application.partner.report.control.tab.overviewAndFinalize.followup.measures.info' | translate}}</p>
    <jems-expandable-textarea jemsMultiColumnRow class="w-50"
                              [control]="overviewForm?.controls?.followUpMeasuresFromLastReport"
                              [errors]="overviewForm?.controls?.followUpMeasuresFromLastReport.errors"
                              [characterLimit]="5000"
                              [minRows]="1"
                              [maxRows]="15">
    </jems-expandable-textarea>

    <h3>{{'project.application.partner.report.control.tab.overviewAndFinalize.conclusions.and.recommendations.title' | translate}}</h3>
    <p>{{'project.application.partner.report.control.tab.overviewAndFinalize.conclusions.and.recommendations.info' | translate}}</p>
    <jems-expandable-textarea jemsMultiColumnRow class="w-50"
                              [control]="overviewForm?.controls?.conclusion"
                              [errors]="overviewForm?.controls?.conclusion.errors"
                              [characterLimit]="5000"
                              [minRows]="1"
                              [maxRows]="15">
    </jems-expandable-textarea>

    <h3>{{'project.application.partner.report.control.tab.overviewAndFinalize.followup.partner.report.measures.title' | translate}}</h3>
    <p>{{'project.application.partner.report.control.tab.overviewAndFinalize.followup.partner.report.measures.info' | translate}}</p>
    <jems-expandable-textarea jemsMultiColumnRow class="w-50"
                              [control]="overviewForm?.controls?.followUpMeasuresForNextReport"
                              [errors]="overviewForm?.controls?.followUpMeasuresForNextReport.errors"
                              [characterLimit]="5000"
                              [minRows]="1"
                              [maxRows]="15">
    </jems-expandable-textarea>

    <jems-alert *ngIf="error$ | async as error" [show]="!!error.i18nMessage?.i18nKey" [type]="Alert.ERROR">
        <jems-api-error-content [error]="error" [showId]="true"></jems-api-error-content>
    </jems-alert>
    <jems-alert show="true" *ngIf="data.userCanView && !data.userCanEdit && data.finalizationAllowed" [type]="Alert.INFO" [closable]="false">
        <span>{{ 'project.application.partner.report.finalize.no.edit.permission' | translate }}</span>
    </jems-alert>
    <jems-alert show="true" *ngIf="data.userCanEdit && !data.finalizationAllowed" [type]="Alert.INFO" [closable]="false">
        <span>{{ 'project.application.partner.report.finalize.wrong.status' | translate }}</span>
    </jems-alert>
    <div jemsNoWidthLimit *ngIf="data.userCanEdit && data.finalizationAllowed && !overviewForm.dirty" class="mt-3">
        <jems-pending-button
                [confirm]="{ title: 'project.application.partner.report.button.finalize', message: 'project.application.partner.report.finalize.dialog.message' }"
                [pending]="finalizationLoading"
                [icon]="'workspace_premium'"
                (clicked)="finalizeReport(data.partnerId, data.reportId)"
                class="mr-2 mt-2">
            {{ 'project.application.partner.report.button.finalize' | translate }}
        </jems-pending-button>
    </div>

    <h3>{{'project.application.partner.report.control.tab.overviewAndFinalize.certificate.export.title' | translate}}</h3>
    <jems-partner-control-report-generate-control-report-and-certificate
            [partnerId]=data.partnerId
            [reportId]=data.reportId>
    </jems-partner-control-report-generate-control-report-and-certificate>

</jems-form>
