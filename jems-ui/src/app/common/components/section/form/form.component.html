<mat-card class="edit-form-wrapper"
          [class.active-card]="formService.dirty$ | async">

    <mat-card-content class="content">
        <ng-content></ng-content>
    </mat-card-content>

    <ng-container *ngIf="formService.dirty$ | async"
                  [ngTemplateOutlet]="saveDiscard">
    </ng-container>
    <ng-container *ngIf="formService.success$ | async as success"
                  [ngTemplateOutlet]="saveSuccess"
                  [ngTemplateOutletContext]="{$implicit: success}">
    </ng-container>
    <ng-container *ngIf="formService.error$ | async as error"
                  [ngTemplateOutlet]="saveError"
                  [ngTemplateOutletContext]="{$implicit: error}">
    </ng-container>
</mat-card>

<ng-template #saveDiscard>
    <mat-card-footer [@slideInOut] class="footer">
        <button mat-stroked-button class="action-button discard" type="button"
                (click)="formService.setDirty(false); this.discard.emit(); formService.reset()">
            <mat-icon>cancel</mat-icon>&nbsp;{{'common.cancel.label' | translate}}
        </button>
        <button [disabled]="(formService.valid$ | async) === false"
                mat-raised-button class="action-button" color="primary" type="button"
                (click)="formService.setDirty(false); save.emit()">
            <div class="spinner-wrapper">
                <mat-icon *ngIf="false">save</mat-icon>
                <mat-spinner *ngIf="true" class="loader" color="warn" [diameter]="17"></mat-spinner>
                &nbsp;{{formService.saveLabel | translate}}
            </div>
        </button>
    </mat-card-footer>
</ng-template>

<ng-template #saveSuccess let-message>
    <mat-card-footer [@slideInOut] class="footer">
        <div class="message-wrapper">
            <div class="message app-alert-success">
                <em class="far fa-check-circle"></em>
                <span *ngIf="message.i18nKey">{{message.i18nKey | translate : message.i18nArguments}}</span>
                <span *ngIf="!message.i18nKey">{{message | translate}}</span>
            </div>
        </div>
    </mat-card-footer>
</ng-template>

<ng-template #saveError let-error>
    <mat-card-footer [@slideInOut] class="footer">
        <div class="message-wrapper">
            <div class="message app-alert-danger">
                <em class="fas fa-exclamation-triangle mr-4"></em>
                <div>
                    <div>
                        <span class="mat-body-strong">
                            {{error?.i18nMessage.i18nKey ?
                          (error?.i18nMessage.i18nKey | translate) : error?.message}}
                        </span>
                        <span *ngIf="error?.code" class="ml-1 mat-body-strong">(error code: {{error?.code | translate}}
                            )</span>
                    </div>
                    <div class="detail-error ml-3 mt-1" *ngFor="let detail of error?.details as any">
                          <span>
                               {{$any(detail).i18nMessage.i18nKey ?
                            ($any(detail)?.i18nMessage.i18nKey | translate) : detail?.message}}
                           </span>
                        <span *ngIf="detail?.code" class="ml-1">(error code: {{detail?.code | translate}})</span>
                    </div>
                </div>
            </div>
        </div>
        <ng-container *ngTemplateOutlet="saveDiscard"></ng-container>
    </mat-card-footer>
</ng-template>
