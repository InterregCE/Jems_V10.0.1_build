<app-main-page-template [needsCard]="true" *ngIf="data$ | async as data"
                        titleKey="programme.data.page.title"
                        subTitleKey="programme.priority.add.title">
    <form appFormLayout [formGroup]="form">
        <div page-sub-title appMultiColumnRow>
            <h2 class="mb-0">{{'programme.priority.add.title' | translate}}</h2>
            <button color="primary" mat-raised-button
                    *ngIf="form.disabled && (programmeEditableStateStore.hasEditPermission$ | async)"
                    (click)="form.enable(); resetForm(data.priority, data.freePrioritiesWithPolicies)">
                {{'common.edit.label' | translate}}
            </button>
        </div>
        <div appMultiColumnRow stretch>
            <mat-form-field appFormFieldWidth="large">
                <mat-label>{{'programme.priority.field.code' | translate}}</mat-label>
                <input #codeInput [formControlName]="constants.CODE.name" matInput required>
                <mat-hint [appHintFor]="codeInput" [hide]="form.get(constants.CODE.name)?.errors !== null">
                    <app-text-hint [currentLength]="codeInput?.value?.length" [maxLength]="50"></app-text-hint>
                </mat-hint>
                <mat-error>
                    <app-form-field-errors
                            [errors]="form.get(constants.CODE.name)?.errors"
                            [messages]="constants.CODE.errorMessages">
                    </app-form-field-errors>
                </mat-error>
            </mat-form-field>

            <app-multi-language-container [useSystemLanguages]="true"
                                          [switchButtonsVisible]="!form.disabled">
                <app-multi-language-form-field
                        [formControlName]="constants.TITLE.name"
                        label="programme.priority.field.title"
                        [maxLength]="300">
                </app-multi-language-form-field>
            </app-multi-language-container>
        </div>

        <h3>{{'programme.priority.add.objective.title' | translate}}</h3>

        <mat-form-field>
            <mat-label>{{'programme.priority.field.objective.select' | translate}}</mat-label>
            <mat-select [formControlName]="constants.OBJECTIVE.name" required
                        (selectionChange)="changeCurrentObjective($event.value, data.freePrioritiesWithPolicies)"
                        [disabled]="isProgrammeSetupLocked && priorityId">
                <mat-option *ngFor="let objective of data.objectives" [value]="objective">
                    {{objective}} - {{'programme.objective.' + objective | translate}}
                </mat-option>
            </mat-select>
            <mat-error>
                <app-form-field-errors
                        [errors]="form.get(constants.OBJECTIVE.name)?.errors"
                        [messages]="constants.OBJECTIVE.errorMessages">
                </app-form-field-errors>
            </mat-error>
        </mat-form-field>

        <ng-container *ngIf="specificObjectives.length">
            <h3>{{'programme.priority.objective.title' | translate}}</h3>
            <div appNoWidthLimit
                 [appTableConfig]="[{maxInRem: 2},{maxInRem:16},{}]">
                <div>
                    <span></span>
                    <div class="mat-body-strong">{{'programme.priority.objective.table.column.code' | translate}}</div>
                    <div class="mat-body-strong">{{'programme.priority.objective.table.column.title' | translate}}</div>
                </div>
                <div *ngFor="let control of specificObjectives.controls; let i=index"
                     [formArrayName]="constants.SPECIFIC_OBJECTIVES.name">
                    <ng-container [formGroupName]="i">
                        <mat-checkbox
                                [formControlName]="constants.POLICY_SELECTED.name"
                                (change)="setCheckedStatus(i, $event.checked)">
                        </mat-checkbox>
                        <div>
                            <mat-form-field appFormFieldWidth="full" extendError>
                                <mat-label>{{'programme.priority.objective.table.field.code' | translate}}</mat-label>
                                <input #policyCode [formControlName]="constants.POLICY_CODE.name" [required]="control.get(constants.POLICY_SELECTED.name).value" matInput>
                                <mat-hint [appHintFor]="policyCode" [hide]="control.get(constants.POLICY_CODE.name)?.errors !== null">
                                    <app-text-hint [currentLength]="policyCode?.value?.length" [maxLength]="50"></app-text-hint>
                                </mat-hint>
                                <mat-error>
                                    <app-form-field-errors
                                            [errors]="control.get(constants.POLICY_CODE.name)?.errors"
                                            [messages]="constants.POLICY_CODE.errorMessages">
                                    </app-form-field-errors>
                                </mat-error>
                            </mat-form-field>
                        </div>

                    </ng-container>
                    <div>{{'programme.policy.' + control.get(constants.POLICY_OBJECTIVE.name).value | translate}}</div>
                </div>
            </div>
            <mat-error>
                <app-form-field-errors
                        [errors]="form.get(constants.SPECIFIC_OBJECTIVES.name)?.errors"
                        [messages]="constants.SPECIFIC_OBJECTIVES.errorMessages">
                </app-form-field-errors>
            </mat-error>
        </ng-container>

        <!--TODO: remove when new edit mode is introduced-->
        <div appMultiColumnRow *ngIf="form.enabled">
            <button mat-stroked-button type="button"
                    (click)="cancel(data.priority, data.freePrioritiesWithPolicies)">
                {{'programme.priority.button.cancel' | translate}}
            </button>
            <button mat-raised-button color="primary" type="button"
                    [disabled]="form.invalid"
                    (click)="submit()">
                <span *ngIf="!priorityId">{{'programme.priority.button.add' | translate}}</span>
                <span *ngIf="priorityId">{{'programme.priority.button.update' | translate}}</span>
            </button>
        </div>

        <app-alert [show]="!!saveSuccess"
                   [type]="Alert.SUCCESS">
            <p>{{saveSuccess | translate}}</p>
        </app-alert>
        <app-alert *ngIf="saveError"
                   [show]="!!saveError"
                   [type]="Alert.ERROR">
            <app-api-error-content *ngIf="!!saveError.i18nMessage.i18nKey" [error]="saveError"></app-api-error-content>

            <p *ngIf="!saveError.i18nMessage.i18nKey && !specificObjectiveError()">
                {{'programme.priority.code.or.title.already.in.use' | translate}}
            </p>

            <p *ngIf="!!specificObjectiveError()">
                {{specificObjectiveError()?.i18nKey | translate : specificObjectiveError()?.i8nArguments }}
            </p>
        </app-alert>
    </form>
</app-main-page-template>
