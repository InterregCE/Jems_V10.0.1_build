<div jemsFormLayout>
    <h3 class="mt-4">{{ 'payments.to.ec.detail.ftls.tab.cumulative.amounts.title' | translate }}</h3>
    <div>
        <div>{{ 'payments.to.ec.detail.ftls.tab.cumulative.amounts.description.1' | translate }}</div>
        <div>{{ 'payments.to.ec.detail.ftls.tab.cumulative.amounts.description.2' | translate }}</div>
    </div>
    <ng-container *ngIf="cumulativeForCurrentTab$ | async as cumulativeForCurrentTab">
        <jems-payment-to-ec-cumulative-table [data]=cumulativeForCurrentTab.data></jems-payment-to-ec-cumulative-table>
    </ng-container>
</div>

<div class="mt-5">
    <h3>{{ 'payments.to.ec.detail.ftls.tab.title' | translate }}</h3>
    <div class="mb-2">
        <div>{{ 'payments.to.ec.detail.ftls.tab.description.1' | translate }}</div>
        <div>{{ 'payments.to.ec.detail.ftls.tab.description.2' | translate }}</div>
    </div>

    <jems-alert *ngIf="error$ | async as error"
                [show]="!!error.i18nMessage?.i18nKey"
                [type]="Alert.ERROR">
        <jems-api-error-content [error]="error"></jems-api-error-content>
    </jems-alert>

    <ng-container *ngIf="data$ | async as data">

        <jems-alert [show]="successfulUpdateMessage"
                    [type]="Alert.SUCCESS">
            <p>{{'payments.to.ec.detail.ftls.update.save.message' | translate}}</p>
        </jems-alert>

        <ng-container *ngIf="data.ecFTLSs.totalElements">
            <mat-table jemsNoWidthLimit matSort (matSortChange)="pageStore.ftlsNewSort$.next($event)" [dataSource]="dataSource">

                <ng-container matColumnDef="select" sticky>
                    <mat-header-cell *matHeaderCellDef class="text-center border-cell-right">
                        <span jemsText maxLines="2">{{ 'payments.to.ec.detail.ftls.column.select' | translate }}</span>
                    </mat-header-cell>
                    <mat-cell *matCellDef="let i = index" class="text-center border-cell-right">
                        <mat-checkbox [checked]="data.ecFTLSs.content[i].paymentToEcId !== null"
                                      [disabled]="!data.isEditable || editedRowIndex !== null"
                                      (change)="selectionChanged(data.ecId, data.ecFTLSs.content[i].payment.id, data.ecFTLSs.content[i].paymentToEcId !== null, $event)">
                        </mat-checkbox>
                    </mat-cell>
                </ng-container>

                <ng-container matColumnDef="projectId">
                    <mat-header-cell *matHeaderCellDef mat-sort-header="projectCustomIdentifier">
                        <span jemsText maxLines="2">{{ 'payments.to.ec.detail.ftls.column.project.id' | translate }}</span>
                    </mat-header-cell>
                    <mat-cell *matCellDef="let i = index">
                        {{data.ecFTLSs.content[i].payment.projectCustomIdentifier}}
                    </mat-cell>
                </ng-container>

                <ng-container matColumnDef="projectAcronym">
                    <mat-header-cell *matHeaderCellDef mat-sort-header="projectAcronym">
                        <span jemsText maxLines="2">{{ 'payments.to.ec.detail.ftls.column.project.acronym' | translate }}</span>
                    </mat-header-cell>
                    <mat-cell *matCellDef="let i = index">
                        {{data.ecFTLSs.content[i].payment.projectAcronym}}
                    </mat-cell>
                </ng-container>

                <ng-container matColumnDef="priorityAxis">
                    <mat-header-cell *matHeaderCellDef>
                        <span jemsText maxLines="2">{{ 'payments.to.ec.detail.ftls.column.priority.axis' | translate }}</span>
                    </mat-header-cell>
                    <mat-cell *matCellDef="let i = index">
                        {{data.ecFTLSs.content[i].priorityAxis}}
                    </mat-cell>
                </ng-container>

                <ng-container matColumnDef="claimNo">
                    <mat-header-cell *matHeaderCellDef>
                        <span jemsText maxLines="2">{{ 'payments.to.ec.detail.ftls.column.claim.no' | translate }}</span>
                    </mat-header-cell>
                    <mat-cell *matCellDef="let i = index">
                        {{data.ecFTLSs.content[i].payment.paymentClaimNo}}
                    </mat-cell>
                </ng-container>

                <ng-container matColumnDef="maApprovalDate">
                    <mat-header-cell *matHeaderCellDef mat-sort-header="maApprovalDate">
                        <span jemsText maxLines="2">{{ 'payments.to.ec.detail.ftls.column.ma.approval.date' | translate }}</span>
                    </mat-header-cell>
                    <mat-cell *matCellDef="let i = index">
                        {{ data.ecFTLSs.content[i].payment.paymentApprovalDate | localeDate: 'L'}}
                    </mat-cell>
                </ng-container>

                <ng-container matColumnDef="totalEligible">
                    <mat-header-cell class="text-right" *matHeaderCellDef>
                        <span jemsText maxLines="2">{{ 'payments.to.ec.detail.ftls.column.total.eligible' | translate }}</span>
                    </mat-header-cell>
                    <mat-cell *matCellDef="let i = index" class="text-right">
                        {{ (data.ecFTLSs.content[i].payment.amountApprovedPerFund + data.ecFTLSs.content[i].partnerContribution) | asMoney}}
                    </mat-cell>
                </ng-container>

                <ng-container matColumnDef="fundAmount">
                    <mat-header-cell class="text-right" *matHeaderCellDef>
                        <span jemsText maxLines="2">{{ 'payments.to.ec.detail.ftls.column.fund.amount' | translate }}</span>
                    </mat-header-cell>
                    <mat-cell *matCellDef="let i = index" class="text-right">
                        {{ data.ecFTLSs.content[i].payment.amountApprovedPerFund | asMoney}}
                    </mat-cell>
                </ng-container>

                <ng-container matColumnDef="partnerContribution">
                    <mat-header-cell class="text-right" *matHeaderCellDef>
                        <span jemsText maxLines="2">{{ 'payments.to.ec.detail.ftls.column.partner.contribution' | translate }}</span>
                    </mat-header-cell>
                    <mat-cell *matCellDef="let i = index" class="text-right">
                        {{ data.ecFTLSs.content[i].partnerContribution | asMoney}}
                    </mat-cell>
                </ng-container>

                <form [formGroup]="form">
                    <ng-container formArrayName="ecFTLSs">
                        <ng-container matColumnDef="publicContribution">
                            <mat-header-cell class="text-right" *matHeaderCellDef>
                                <span jemsText maxLines="2">{{ 'payments.to.ec.detail.ftls.column.public.contribution' | translate }}</span>
                            </mat-header-cell>
                            <mat-cell *matCellDef="let ftls; let i = index" class="text-right">
                                <div *ngIf="i !== editedRowIndex">
                                    {{ ftls.get('ftlsPublicContribution').value | asMoney}}
                                </div>
                                <div *ngIf="i === editedRowIndex">
                                    <mat-form-field [formGroup]="ftls" class="limit-input-width">
                                        <input  matInput formControlName="ftlsPublicContribution" [options]="{align: 'right'}" currencyMask matInput type="decimal">
                                    </mat-form-field>
                                    <div  class="limit-input-width">
                                        <button class="w-100" (click)="resetAmounts(i, data.ecFTLSs.content[i])" mat-stroked-button>
                                            {{ 'payments.to.ec.detail.ftls.update.reset' | translate }}
                                        </button>
                                    </div>
                                </div>
                            </mat-cell>
                        </ng-container>

                        <ng-container matColumnDef="autoPublicContribution">
                            <mat-header-cell class="text-right" *matHeaderCellDef>
                                <span jemsText maxLines="2">{{ 'payments.to.ec.detail.ftls.column.auto.public.contribution' | translate }}</span>
                            </mat-header-cell>
                            <mat-cell *matCellDef="let ftls; let i = index" [formGroup]="ftls" class="text-right">
                                <span *ngIf="i !== editedRowIndex">
                                    {{ ftls.get('ftlsAutoPublicContribution').value | asMoney}}
                                </span>
                                <div *ngIf="i === editedRowIndex">
                                    <mat-form-field  class="limit-input-width">
                                        <input matInput formControlName="ftlsAutoPublicContribution" [options]="{align: 'right'}" currencyMask matInput type="decimal">
                                    </mat-form-field>
                                    <div class="limit-input-width">
                                        <button (click)="discardChanges(i, data.ecFTLSs.content[i])" class="w-100" mat-stroked-button>
                                            {{'payments.to.ec.detail.ftls.update.discard' | translate}}
                                        </button>
                                    </div>
                                </div>
                            </mat-cell>
                        </ng-container>

                        <ng-container matColumnDef="privateContribution">
                            <mat-header-cell class="text-right" *matHeaderCellDef>
                                <span jemsText maxLines="2">{{ 'payments.to.ec.detail.ftls.column.private.contribution' | translate }}</span>
                            </mat-header-cell>
                            <mat-cell *matCellDef="let ftls; let i = index" class="text-right">
                                <span *ngIf="i !== editedRowIndex">
                                    {{ ftls.get('ftlsPrivateContribution').value | asMoney}}
                                </span>
                                <div *ngIf="i === editedRowIndex">
                                    <mat-form-field [formGroup]="ftls" class="limit-input-width">
                                        <input matInput formControlName="ftlsPrivateContribution" [options]="{align: 'right'}" currencyMask matInput type="decimal">
                                    </mat-form-field>
                                    <div class="limit-input-width">
                                        <button (click)="submitAmountChanges(i, data.ecId, data.ecFTLSs.content[i].payment.id)" mat-flat-button type="submit" color="primary" class="w-100">
                                            <mat-icon class="save-icon">save</mat-icon> {{'payments.to.ec.detail.ftls.update.save' | translate}}
                                        </button>
                                    </div>
                                </div>
                            </mat-cell>
                        </ng-container>
                    </ng-container>
                </form>

                <ng-container matColumnDef="correction">
                    <mat-header-cell *matHeaderCellDef class="text-center border-cell-left">
                        <span jemsText maxLines="2">{{ 'payments.to.ec.detail.ftls.column.correct.amounts' | translate }}</span>
                    </mat-header-cell>
                    <mat-cell *matCellDef="let ftls;let i = index" class="text-center border-cell-left">
                        <button *ngIf="i !== editedRowIndex" (click)="editAmounts(i)"
                                [disabled]="!data.isEditable || editedRowIndex !== null"
                                color="primary" mat-icon-button matTooltip="{{ 'payments.to.ec.detail.ftls.column.correct.amounts.tooltip' | translate }}"
                                aria-label="edit">
                            <mat-icon>edit</mat-icon>
                        </button>
                    </mat-cell>
                </ng-container>

                <mat-header-row *matHeaderRowDef="displayedColumns"></mat-header-row>
                <mat-row *matRowDef="let row;let i = index; columns: displayedColumns" [class.edited-row]="i === editedRowIndex"></mat-row>

            </mat-table>

            <jems-paginator
                    [length]="data.ecFTLSs.totalElements"
                    [currentPageIndex]="data.ecFTLSs.pageable.pageNumber"
                    [currentPageSize]="data.ecFTLSs.pageable.pageSize"
                    (pageIndexChanged)="pageStore.ftlsNewPageIndex$.next($event)"
                    (pageSizeChanged)="pageStore.ftlsNewPageSize$.next($event)">
            </jems-paginator>
        </ng-container>

        <jems-alert [show]="data.ecFTLSs.content?.length === 0" [type]="Alert.INFO">
            <p>{{ 'payments.to.ec.detail.ftls.table.empty' | translate }}</p>
        </jems-alert>
    </ng-container>
    <jems-regular-payments-not-flagged-9495></jems-regular-payments-not-flagged-9495>
</div>
